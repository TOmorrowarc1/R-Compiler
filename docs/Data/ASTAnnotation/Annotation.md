# AST 标注系统概述

## 简介

AST 标注系统定义编译器 Semantic 与 IR 阶段需要的语义信息类并负责在 AST 与 相应位置添加语义信息。该系统通过分析 AST 节点，为其添加类型、常量值、符号引用等语义信息，为后续的代码生成和优化提供必要的数据支持。

## 系统架构

AST 标注系统由以下几个核心组件构成：

1. **ConstEvaluator（常量求值器）**：负责常量表达式的求值和类型定义的处理。
2. **ConstInfo（常量信息）**：存储常量的类型和值信息。
3. **ConstValue（常量值）**：表示各种类型的常量值。
4. **Scope（作用域）**：管理符号的作用域和层次结构。
5. **Symbol（符号）**：表示程序中的各种符号（变量、函数、类型等）。
6. **TraitDef（特征定义）**：定义语言的 trait（特征）系统。
7. **TypeDef（类型定义）**：定义程序中的类型系统。
8. **TypeKind（类型种类）**：表示不同种类的类型。
9. **ValueInfo（值信息）**：存储值的类型和属性信息。

## 组件关系

```
┌─────────────────────────────────────────────────────────────┐
│                    ConstEvaluator                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  ConstInfo  │  │   Scope     │  │   TypeKind  │        │
│  │  ┌─────────┐│  │  ┌─────────┐│  │  ┌─────────┐│        │
│  │  │ConstValu││  │  │ Symbol  ││  │  │ TypeDef ││        │
│  │  │   e     ││  │  │         ││  │  │         ││        │
│  │  └─────────┘│  │  └─────────┘│  │  └─────────┘│        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      ValueInfo                               │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  TraitDef   │  │   Symbol    │  │   TypeDef   │        │
│  │             │  │             │  │             │        │
│  └─────────────┘  └─────────────┘  └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

## 工作流程

1. **初始化阶段**：
   - 创建全局作用域
   - 注册内置类型和函数
   - 初始化常量求值器

2. **标注阶段**：
   - 遍历 AST 节点
   - 为每个节点添加相应的语义信息
   - 处理类型推导和常量求值
   - 构建符号表和作用域层次结构

3. **验证阶段**：
   - 检查类型一致性
   - 验证常量表达式的正确性
   - 确保符号引用的有效性

## 主要功能

### 常量求值

- 支持基本类型的常量表达式求值
- 处理类型定义中的常量
- 支持 trait 和 impl 中的常量求值

### 类型系统

- 支持结构体和枚举类型
- 提供类型推导功能
- 支持引用类型和数组类型
- 实现 trait 系统

### 符号管理

- 层次化作用域管理
- 支持变量、函数、类型和常量符号
- 提供符号查找和解析功能

## 设计特点

1. **模块化设计**：各组件职责明确，接口清晰
2. **类型安全**：使用智能指针和类型系统确保内存安全
3. **可扩展性**：支持新类型和特征的添加
4. **高效性**：使用哈希表等数据结构提高查找效率

## 使用示例

```cpp
// 创建常量求值器
ConstEvaluator evaluator;

// 绑定当前作用域
evaluator.bindScopePointer(&current_scope);

// 添加内置符号
evaluator.addBuiltInSymbol("i32");

// 将 AST 节点附加到类型定义
evaluator.attachNodeToTypeDef(node, "MyStruct");

// 评估类型符号
evaluator.evaluateTypeSymbol("MyStruct");

// 评估常量符号
evaluator.evaluateConstSymbol("MY_CONSTANT");
```

## 总结

AST 标注系统是编译器的核心组件之一，它为 AST 节点添加丰富的语义信息，为后续的代码生成和优化提供基础。该系统采用模块化设计，具有良好的可扩展性和维护性。